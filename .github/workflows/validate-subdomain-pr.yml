name: üõ°Ô∏è Validate Subdomain PR

on:
  pull_request:
    paths:
      - "domains/**"

jobs:
  validate-json:
    runs-on: ubuntu-latest
    name: ‚úÖ Validate Subdomain JSON

    steps:
      - name: ‚¨áÔ∏è Checkout Repository
        uses: actions/checkout@v3

      - name: üîé Find Changed JSON Files
        id: changed-files
        uses: tj-actions/changed-files@v39
        with:
          files: |
            domains/**/*.json

      - name: üìÇ Validate Changed JSON Files
        run: |
          INVALID=0
          for file in ${{ steps.changed-files.outputs.all_changed_files }}; do
            echo "Validating: $file"

            # Check JSON syntax
            if ! jq . "$file" > /dev/null 2>&1; then
              echo "‚ùå Invalid JSON syntax in $file"
              INVALID=1
              continue
            fi

            # Extract keys safely
            NAME=$(jq -r '.name // empty' "$file")
            SUBDOMAIN=$(jq -r '.subdomain // empty' "$file")
            CNAME=$(jq -r '.records.CNAME[0] // empty' "$file")

            # Check required fields
            if [[ -z "$NAME" || -z "$SUBDOMAIN" || -z "$CNAME" ]]; then
              echo "‚ùå Missing required fields in $file"
              INVALID=1
            fi
          done

          if [[ $INVALID -eq 1 ]]; then
            echo "‚ùå One or more JSON files are invalid."
            exit 1
          fi

      - name: ‚úÖ All Good!
        run: echo "üéâ All submitted subdomain files are valid!"
